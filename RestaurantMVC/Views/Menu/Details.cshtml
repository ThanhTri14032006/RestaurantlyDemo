@model RestaurantMVC.Models.MenuItem
@{
    ViewData["Title"] = Model?.Name ?? "Chi tiết món ăn";
}

<link rel="stylesheet" href="~/css/pages/Menu/Details.css" asp-append-version="true" />

@if (Model != null)
{
    <div class="container py-5 details-page">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Menu")">Thực đơn</a></li>
                <li class="breadcrumb-item active">@Model.Name</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Image Section -->
            <div class="col-lg-6 mb-4">
                <div class="position-relative">
                    <img src="@(string.IsNullOrEmpty(Model.ImageUrl) ? "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'><rect width='100%25' height='100%25' fill='%23f0f0f0'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23999' font-size='24'>No Image</text></svg>" : Model.ImageUrl)"
                        class="img-fluid rounded shadow" alt="@Model.Name"
                        style="width: 100%; height: 400px; object-fit: cover;"
                        onerror="this.onerror=null; this.src='data:image/svg+xml;charset=UTF-8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'600\' height=\'400\'><rect width=\'100%25\' height=\'100%25\' fill=\'%23f0f0f0\'/><text x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'%23999\' font-size=\'24\'>No Image</text></svg>';">
                    @if (!Model.IsAvailable)
                    {
                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center rounded"
                            style="background: rgba(0,0,0,0.7);">
                            <span class="badge bg-danger fs-4">Hết món</span>
                        </div>
                    }
                    <div class="position-absolute top-0 end-0 m-3">
                        <span class="badge bg-primary fs-6">@Model.Category</span>
                    </div>
                </div>
            </div>

            <!-- Details Section -->
            <div class="col-lg-6">
                <div class="h-100 d-flex flex-column">
                    <div class="mb-4">
                        <h1 class="display-5 fw-bold mb-3">@Model.Name</h1>
                        <div class="d-flex align-items-center mb-3">
                            <span class="h2 text-primary me-3">@Model.Price.ToString("N0") VNĐ</span>
                            @if (Model.IsAvailable)
                            {
                                <span class="badge bg-success fs-6">Còn món</span>
                            }
                            else
                            {
                                <span class="badge bg-danger fs-6">Hết món</span>
                            }
                        </div>
                    </div>

                    <div class="mb-4">
                        <h5 class="fw-bold mb-3">Mô tả món ăn</h5>
                        <p class="lead">@Model.Description</p>
                    </div>

                    <div class="mb-4">
                        <h5 class="fw-bold mb-3">Thông tin chi tiết</h5>
                        <div class="row">
                            <div class="col-sm-6 mb-2">
                                <strong>Danh mục:</strong> @Model.Category
                            </div>
                            <div class="col-sm-6 mb-2">
                                <strong>Trạng thái:</strong>
                                @if (Model.IsAvailable)
                                {
                                    <span class="text-success">Còn món</span>
                                }
                                else
                                {
                                    <span class="text-danger">Hết món</span>
                                }
                            </div>
                            <div class="col-sm-6 mb-2">
                                <strong>Ngày tạo:</strong> @Model.CreatedAt.ToString("dd/MM/yyyy")
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-auto">
                        <div class="d-flex gap-3 mb-3">
                            <button type="button" id="btnAddToCart" class="btn btn-success btn-lg flex-fill">
                                <i class="fas fa-shopping-cart me-2"></i>Thêm vào giỏ
                            </button>
                            <a href="@Url.Action("Index", "Booking")" class="btn btn-primary btn-lg flex-fill">
                                <i class="fas fa-calendar-alt me-2"></i>Đặt bàn ngay
                            </a>
                            <a href="@Url.Action("Index", "Menu")" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-arrow-left me-2"></i>Quay lại
                            </a>
                        </div>

                        <!-- Share Buttons -->
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="shareOnFacebook()">
                                <i class="fab fa-facebook-f me-1"></i>Chia sẻ
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="copyLink()">
                                <i class="fas fa-link me-1"></i>Sao chép link
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="fw-bold mb-4">
                    <i class="fas fa-star text-warning me-2"></i>Đánh giá món ăn
                </h3>

                <!-- Review Statistics -->
                <div id="reviewStats" class="mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-4">
                            <span class="h4 mb-0" id="averageRating">0</span>
                            <div class="rating-display" id="averageStars"></div>
                        </div>
                        <div>
                            <span id="totalReviews">0</span> đánh giá
                        </div>
                    </div>
                </div>

                <!-- Add Review Form -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Thêm đánh giá của bạn</h5>
                    </div>
                    <div class="card-body">
                        <form id="reviewForm">
                            <input type="hidden" name="MenuItemId" value="@Model.Id" />

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tên của bạn *</label>
                                    <input type="text" name="CustomerName" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email *</label>
                                    <input type="email" name="Email" class="form-control" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Đánh giá *</label>
                                <div class="rating-input">
                                    <input type="radio" name="Rating" value="5" id="star5">
                                    <label for="star5" title="5 sao">★</label>
                                    <input type="radio" name="Rating" value="4" id="star4">
                                    <label for="star4" title="4 sao">★</label>
                                    <input type="radio" name="Rating" value="3" id="star3">
                                    <label for="star3" title="3 sao">★</label>
                                    <input type="radio" name="Rating" value="2" id="star2">
                                    <label for="star2" title="2 sao">★</label>
                                    <input type="radio" name="Rating" value="1" id="star1">
                                    <label for="star1" title="1 sao">★</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Nhận xét</label>
                                <textarea name="Comment" class="form-control" rows="4"
                                placeholder="Chia sẻ trải nghiệm của bạn về món ăn này..."></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i>Gửi đánh giá
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Reviews List -->
                <div id="reviewsList">
                    <div class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="mt-2">Đang tải đánh giá...</p>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <button id="loadMoreReviews" class="btn btn-outline-primary" style="display: none;">
                        Xem thêm đánh giá
                    </button>
                </div>
            </div>
        </div>

        <!-- Related Items Section -->
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="fw-bold mb-4">Món ăn cùng danh mục</h3>
                <div class="text-center py-4">
                    <p class="text-muted">Các món ăn khác trong danh mục "@Model.Category" sẽ được hiển thị tại đây</p>
                    <a href="@Url.Action("Index", "Menu", new { category = Model.Category })" class="btn btn-primary">
                        <i class="fas fa-eye me-2"></i>Xem tất cả món @Model.Category
                    </a>
                </div>
            </div>
        </div>

        <!-- Recommendation Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="bg-light p-4 rounded">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="fw-bold mb-2">Thích món này?</h5>
                            <p class="mb-0">Đặt bàn ngay để thưởng thức @Model.Name cùng với những món ăn tuyệt vời khác!
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <a href="@Url.Action("Index", "Booking")" class="btn btn-warning btn-lg">
                                <i class="fas fa-calendar-alt me-2"></i>Đặt bàn
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="container py-5">
        <div class="text-center">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h2>Không tìm thấy món ăn</h2>
            <p class="text-muted">Món ăn bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
            <a href="@Url.Action("Index", "Menu")" class="btn btn-primary">
                <i class="fas fa-arrow-left me-2"></i>Quay lại thực đơn
            </a>
        </div>
    </div>
}

@if (Model != null)
{
    <script>
        let currentReviewPage = 1;
        const menuItemId = @Model.Id;

        document.addEventListener('DOMContentLoaded', function () {
            loadReviewStats();
            loadReviews();

            // Handle review form submission
            document.getElementById('reviewForm').addEventListener('submit', function (e) {
                e.preventDefault();
                submitReview();
            });

            // Handle load more reviews
            document.getElementById('loadMoreReviews').addEventListener('click', function () {
                currentReviewPage++;
                loadReviews(false);
            });
            // Add to cart handler
            const addBtn = document.getElementById('btnAddToCart');
            if (addBtn) {
                addBtn.addEventListener('click', function () {
                    addToCart(menuItemId, 1);
                });
            }
        });

        function loadReviewStats() {
            fetch(`/Review/GetStats?menuItemId=${menuItemId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('averageRating').textContent = data.averageRating;
                        document.getElementById('totalReviews').textContent = data.totalReviews;
                        displayStars('averageStars', data.averageRating);
                    }
                })
                .catch(error => console.error('Error loading review stats:', error));
        }

        function loadReviews(replace = true) {
            fetch(`/Review/GetReviews?menuItemId=${menuItemId}&page=${currentReviewPage}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayReviews(data.reviews, replace);

                        const loadMoreBtn = document.getElementById('loadMoreReviews');
                        if (data.hasMore) {
                            loadMoreBtn.style.display = 'block';
                        } else {
                            loadMoreBtn.style.display = 'none';
                        }
                    }
                })
                .catch(error => console.error('Error loading reviews:', error));
        }

        function displayReviews(reviews, replace = true) {
            const container = document.getElementById('reviewsList');

            if (replace) {
                container.innerHTML = '';
            }

            if (reviews.length === 0 && replace) {
                container.innerHTML = '<div class="text-center py-4 text-muted">Chưa có đánh giá nào</div>';
                return;
            }

            reviews.forEach(review => {
                const reviewHtml = `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">${review.customerName}</h6>
                                <div class="rating-display">${generateStars(review.rating)}</div>
                            </div>
                            <small class="text-muted">${review.createdAt}</small>
                        </div>
                        ${review.comment ? `<p class="mb-0">${review.comment}</p>` : ''}
                    </div>
                </div>
            `;
                container.insertAdjacentHTML('beforeend', reviewHtml);
            });
        }

        function submitReview() {
            const form = document.getElementById('reviewForm');
            const formData = new FormData(form);

            const reviewData = {
                MenuItemId: parseInt(formData.get('MenuItemId')),
                CustomerName: formData.get('CustomerName'),
                Email: formData.get('Email'),
                Rating: parseInt(formData.get('Rating')),
                Comment: formData.get('Comment')
            };

            if (!reviewData.Rating) {
                showNotification('Vui lòng chọn số sao đánh giá', 'error');
                return;
            }

            fetch('/Review/Submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(reviewData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        form.reset();
                        // Reset rating stars
                        document.querySelectorAll('.rating-input label').forEach(label => {
                            label.classList.remove('active');
                        });
                        loadReviewStats();
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error submitting review:', error);
                    showNotification('Có lỗi xảy ra khi gửi đánh giá', 'error');
                });
        }

        function displayStars(containerId, rating) {
            const container = document.getElementById(containerId);
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;

            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= fullStars) {
                    starsHtml += '<i class="fas fa-star text-warning"></i>';
                } else if (i === fullStars + 1 && hasHalfStar) {
                    starsHtml += '<i class="fas fa-star-half-alt text-warning"></i>';
                } else {
                    starsHtml += '<i class="far fa-star text-warning"></i>';
                }
            }

            container.innerHTML = starsHtml;
        }

        function generateStars(rating) {
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starsHtml += '<i class="fas fa-star text-warning"></i>';
                } else {
                    starsHtml += '<i class="far fa-star text-warning"></i>';
                }
            }
            return starsHtml;
        }

        function shareOnFacebook() {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent('@Model?.Name - Restaurantly');
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&t=${title}`, '_blank', 'width=600,height=400');
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(function () {
                alert('Đã sao chép link vào clipboard!');
            }, function (err) {
                console.error('Không thể sao chép link: ', err);
            });
        }

        function addToCart(id, quantity = 1) {
            fetch('/Order/AddToCart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ MenuItemId: id, Quantity: quantity })
            })
                .then(resp => resp.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Đã thêm vào giỏ hàng', 'success');
                        window.location.href = '/Order/Cart';
                    } else {
                        showNotification('Không thể thêm vào giỏ: ' + (data.message || ''), 'error');
                    }
                })
                .catch(err => {
                    console.error('AddToCart error:', err);
                    showNotification('Có lỗi xảy ra khi thêm vào giỏ', 'error');
                });
        }
    </script>
}